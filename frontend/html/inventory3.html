<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Head Content -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - Dashboard</title>

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="css/tailwind.min.css">

    <!-- External JS Files -->
    <script src="js/chart.min.js" defer></script>
    <script src="js/moment.min.js" defer></script>
    <script src="js/chartjs-adapter-moment.min.js" defer></script>
    <script src="js/FileSaver.min.js" defer></script>
    <script src="js/papaparse.min.js" defer></script>
    <script src="js/html2canvas.min.js" defer></script>
    <script src="js/jspdf.umd.min.js" defer></script>
    <script src="js/logout.js" defer></script>
</head>

<body class="flex bg-gray-100 min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md flex flex-col">
        <div class="p-6">
            <img src="img/HB solutions.jpeg" alt="Logo" class="w-16 h-16 mb-4 mx-auto">
            <h2 class="text-center text-xl font-semibold">3008 </h2>
            <nav class="mt-8">
                <ul class="space-y-4">
                    <li id="dashboardMenu">
                        <a href="dash4.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/home.svg" alt="Dashboard Icon" class="w-6 h-6 mr-2" />لوحة التحكم
                        </a>
                    </li>
                    <li id="newSaleMenu">
                        <a href="newSale4.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/shopping-cart.svg" alt="New Sale Icon" class="w-6 h-6 mr-2" />عملية بيع جديدة
                        </a>
                    </li>
                    <li id="inventoryMenu">
                        <a href="inventory3.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/archive.svg" alt="Inventory Icon" class="w-6 h-6 mr-2" />المخزون
                        </a>
                    </li>
                    <li id="ordersMenu">
                        <a href="orders2.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/shopping-cart.svg" alt="Orders Icon" class="w-6 h-6 mr-2" />الطلبات
                        </a>
                    </li>
                    <li id="suppliersMenu">
                        <a href="suppliers.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/truck.svg" alt="Suppliers Icon" class="w-6 h-6 mr-2" />الموردين
                        </a>
                    </li>
                    <li id="customersMenu">
                        <a href="customers.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/users.svg" alt="Customers Icon" class="w-6 h-6 mr-2" />العملاء
                        </a>
                    </li>
                    <li id="adminAccessMenu">
                        <a href="RoleAssign.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/user-plus.svg" alt="Admin Access Icon" class="w-6 h-6 mr-2" />صلاحيات الإدارة
                        </a>
                    </li>
                    <li id="reportsMenu">
                        <a href="saleReport.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/file-text.svg" alt="Reports Icon" class="w-6 h-6 mr-2" />التقارير
                        </a>
                    </li>
                    <li id="gainsMenu">
                        <a href="profitTracking.html" class="flex items-center py-2 px-4 hover:bg-blue-100 rounded">
                            <img src="icons/file-text.svg" alt="Reports Icon" class="w-6 h-6 mr-2" />الأرباح
                        </a>
                    </li>
                    <li>                 
                        <button onclick="logout()"
                            class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <img src="icons/log-out.svg" alt="Logout Icon" class="w-6 h-6 mr-2" />
                            <span>تسجيل الخروج</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>

        
    </aside>

    <!-- Custom Alert -->
    <div id="customAlert" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 max-w-sm p-4 rounded-lg shadow-lg z-50 text-white text-center text-lg transition-opacity duration-300 opacity-0 invisible"></div>

    <!-- Main Content -->
    <div class="flex-1 p-10">
        <!-- Header with Action Buttons -->
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-bold text-gray-900">إدارة المخزون</h1>
            <div class="flex space-x-4">
                <button class="flex items-center bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200" onclick="showProductModal('add')">
                    <img src="icons/plus-circle.svg" alt="Add Product Icon" class="w-5 h-5 mr-2" />
                    إضافة منتج جديد
                </button>
                <button class="flex items-center bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-200" onclick="showPromotionModal()">
                    <img src="icons/award.svg" alt="Promotion Icon" class="w-5 h-5 mr-2" />
                    عرض ترويجي
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <!-- Total Products Card -->
            <div class="flex items-center p-6 bg-white rounded-lg shadow">
                <img src="icons/activity.svg" alt="Total Products Icon" class="w-12 h-12 p-3 bg-blue-100 text-blue-500 rounded-full mr-4" />
                <div>
                    <h3 class="text-gray-500">إجمالي المنتجات</h3>
                    <p class="text-2xl font-bold text-gray-900" id="totalProducts">0</p>
                </div>
            </div>
            <!-- In Stock Card -->
            <div class="flex items-center p-6 bg-white rounded-lg shadow">
                <img src="icons/check-circle.svg" alt="In Stock Icon" class="w-12 h-12 p-3 bg-green-100 text-green-500 rounded-full mr-4" />
                <div>
                    <h3 class="text-gray-500">متوفر في المخزون</h3>
                    <p class="text-2xl font-bold text-gray-900" id="inStockCount">0</p>
                </div>
            </div>
            <!-- Low Stock Card -->
            <div class="flex items-center p-6 bg-white rounded-lg shadow">
                <img src="icons/check-circle (1).svg" alt="Low Stock Icon" class="w-12 h-12 p-3 bg-yellow-100 text-yellow-500 rounded-full mr-4" />
                <div>
                    <h3 class="text-gray-500">مخزون منخفض</h3>
                    <p class="text-2xl font-bold text-gray-900" id="lowStockCount">0</p>
                </div>
            </div>
            <!-- Out of Stock Card -->
            <div class="flex items-center p-6 bg-white rounded-lg shadow">
                <img src="icons/x-octagon.svg" alt="Out of Stock Icon" class="w-12 h-12 p-3 bg-red-100 text-red-500 rounded-full mr-4" />
                <div>
                    <h3 class="text-gray-500">نفاد المخزون</h3>
                    <p class="text-2xl font-bold text-gray-900" id="outOfStockCount">0</p>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white p-6 rounded-lg shadow mb-10">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                <div>
                    <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">الفئة</label>
                    <select id="categoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">جميع الفئات</option>
                        <!-- Dynamic Categories Will Be Populated Here -->
                    </select>
                </div>
                <div>
                    <label for="stockFilter" class="block text-sm font-medium text-gray-700 mb-1">حالة المخزون</label>
                    <select id="stockFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">جميع الحالات</option>
                        <option value="instock">متوفر في المخزون</option>
                        <option value="lowstock">مخزون منخفض</option>
                        <option value="outofstock">نفاد المخزون</option>
                    </select>
                </div>
                <div>
                    <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">ترتيب حسب</label>
                    <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="name">الاسم</option>
                        <option value="stock">مستوى المخزون</option>
                        <option value="price">السعر</option>
                        <option value="storeNumber">رقم المتجر</option>
                    </select>
                </div>
                <div>
                    <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">بحث</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="ابحث عن المنتجات..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <img src="icons/search.svg" alt="Search Icon" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Table -->
        <div class="bg-white p-6 rounded-lg shadow mb-10 overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الباركود</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الفئة</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">المخزون</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">رقم المتجر</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">سعر البيع</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الترويج</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Table content will be dynamically populated -->
                </tbody>
            </table>
        </div>

        <!-- Promotions Table -->
        <div class="bg-white p-6 rounded-lg shadow mb-10 overflow-x-auto">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">العروض الترويجية</h2>
            <table class="min-w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الرقم التعريفي</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الوصف</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ البدء</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ الانتهاء</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الخصم</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="promotionsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Promotions will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Modals -->

        <!-- Add/Edit Product Modal -->
        <div id="productModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden z-50" aria-hidden="true">
            <div class="bg-white rounded-lg w-11/12 max-w-3xl p-6 relative max-h-screen overflow-y-auto">
                <!-- Modal Header -->
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold" id="modalTitle">إضافة منتج جديد</h3>
                    <button class="text-gray-500 hover:text-gray-700" onclick="closeProductModal()">
                        <img src="icons/x-octagon.svg" alt="Close Icon" class="w-6 h-6" />
                    </button>
                </div>
                <!-- Modal Body -->
                <div class="mb-4">
                    <form id="productForm">
                        <!-- Product ID (Optional) -->
                        <div class="mb-4" id="productIdGroup">
                            <label for="productId" class="block text-sm font-medium text-gray-700">معرف المنتج (اختياري)</label>
                            <input type="text" id="productId" placeholder="أدخل معرف المنتج" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <!-- Product Name -->
                        <div class="mb-4">
                            <label for="productName" class="block text-sm font-medium text-gray-700">اسم المنتج <span class="text-red-500">*</span></label>
                            <input type="text" id="productName" placeholder="أدخل اسم المنتج" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <!-- Barcode (Optional) -->
                        <div class="mb-4">
                            <label for="productBarcode" class="block text-sm font-medium text-gray-700">الباركود (اختياري)</label>
                            <input type="text" id="productBarcode" placeholder="أدخل الباركود" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <!-- Purchase Date -->
                        <div class="mb-4">
                            <label for="purchaseDate" class="block text-sm font-medium text-gray-700">تاريخ الشراء <span class="text-red-500">*</span></label>
                            <input type="date" id="purchaseDate" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <!-- Purchase Price -->
                        <div class="mb-4">
                            <label for="purchasePrice" class="block text-sm font-medium text-gray-700">سعر الشراء ($) <span class="text-red-500">*</span></label>
                            <input type="number" id="purchasePrice" min="0" step="0.01" placeholder="أدخل سعر الشراء" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <!-- Selling Price -->
                        <div class="mb-4">
                            <label for="salesPrice" class="block text-sm font-medium text-gray-700">سعر البيع ($) <span class="text-red-500">*</span></label>
                            <input type="number" id="salesPrice" min="0" step="0.01" placeholder="أدخل سعر البيع" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <!-- Supplier -->
                        <div class="mb-4">
                            <label for="supplier" class="block text-sm font-medium text-gray-700">المورد <span class="text-red-500">*</span></label>
                            <select id="supplier" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر المورد...</option>
                                <!-- Options will be populated via JavaScript -->
                            </select>
                        </div>
                        <!-- Description -->
                        <div class="mb-4">
                            <label for="description" class="block text-sm font-medium text-gray-700">الوصف</label>
                            <textarea id="description" placeholder="أدخل الوصف" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <!-- Quantity -->
                        <div class="mb-4">
                            <label for="quantity" class="block text-sm font-medium text-gray-700">الكمية <span class="text-red-500">*</span></label>
                            <input type="number" id="quantity" min="0" placeholder="أدخل الكمية" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <!-- Category -->
                        <div class="mb-4">
                            <label for="categorySelect" class="block text-sm font-medium text-gray-700">الفئة <span class="text-red-500">*</span></label>
                            <select id="categorySelect" onchange="toggleCategoryInput()" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر الفئة...</option>
                                <!-- Existing categories will be populated here -->
                                <option value="newCategory">إضافة فئة جديدة</option>
                            </select>
                            <input type="text" id="categoryInput" placeholder="أدخل فئة جديدة" class="mt-2 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 hidden">
                        </div>
                        <!-- Store Number -->
                        <div class="mb-4">
                            <label for="Store" class="block text-sm font-medium text-gray-700">رقم المتجر <span class="text-red-500">*</span></label>
                            <input type="number" id="Store" placeholder="أدخل رقم المتجر" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </form>
                </div>
                <!-- Modal Footer -->
                <div class="flex justify-end space-x-4">
                    <button type="button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="closeProductModal()">إلغاء</button>
                    <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200 save-button">حفظ المنتج</button>
                </div>
            </div>
        </div>
<!-- Promotion Modal -->
<div id="promotionModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden z-50" aria-hidden="true">
    <div class="bg-white rounded-lg w-11/12 max-w-3xl p-6 relative max-h-screen overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold" id="promotionModalTitle">إضافة عرض ترويجي</h3>
            <button class="text-gray-500 hover:text-gray-700" onclick="closePromotionModal()">
                <img src="icons/x-octagon.svg" alt="Close Icon" class="w-6 h-6" />
            </button>
        </div>
        <!-- Modal Body -->
        <div class="mb-4">
            <form id="promotionForm">
                <!-- Description -->
                <div class="mb-4">
                    <label for="promotionDescription" class="block text-sm font-medium text-gray-700">وصف العرض</label>
                    <textarea id="promotionDescription" placeholder="أدخل وصف العرض" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <!-- Start Date -->
                <div class="mb-4">
                    <label for="promotionStartDate" class="block text-sm font-medium text-gray-700">تاريخ البدء</label>
                    <input type="date" id="promotionStartDate" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- End Date -->
                <div class="mb-4">
                    <label for="promotionEndDate" class="block text-sm font-medium text-gray-700">تاريخ الانتهاء</label>
                    <input type="date" id="promotionEndDate" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- Discount -->
                <div class="mb-4">
                    <label for="promotionDiscount" class="block text-sm font-medium text-gray-700">نسبة الخصم (%)</label>
                    <input type="number" id="promotionDiscount" min="0" max="100" step="0.01" placeholder="أدخل نسبة الخصم" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- Products -->
                <div class="mb-4">
                    <label for="promotionProducts" class="block text-sm font-medium text-gray-700">المنتجات</label>
                    <select id="promotionProducts" multiple class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Product options will be populated dynamically -->
                    </select>
                </div>
            </form>
        </div>
        <!-- Modal Footer -->
        <div class="flex justify-end space-x-4">
            <button type="button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="closePromotionModal()">إلغاء</button>
            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200 save-button">حفظ العرض الترويجي</button>
        </div>
    </div>
</div>


    <!-- Embedded JavaScript -->
    <script>
        // Helper function to format epoch milliseconds to 'YYYY-MM-DD'
        function formatEpochToDate(epoch) {
            if (!epoch) return '';
            const date = new Date(epoch);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Helper function to format date to 'YYYY-MM-DD HH:mm:ss'
        function formatDateToString(dateInput) {
            if (!dateInput) return '';
            const date = new Date(dateInput);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = '00'; // Assuming seconds are not captured via input
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Function to show the Add/Edit Product Modal
        function showProductModal(mode = 'add', product = null) {
            console.log('showProductModal called with mode:', mode, 'product:', product);
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modalTitle');
            const saveButton = modal.querySelector('.save-button');

            // Reset the form
            const form = document.getElementById('productForm');
            form.reset();
            document.getElementById('categoryInput').classList.add('hidden');

            if (mode === 'add') {
                modalTitle.textContent = 'Add New Product';
                saveButton.textContent = 'Save Product';
                saveButton.onclick = handleProductSubmit;
                // Show Product ID field when adding a new product
                document.getElementById('productIdGroup').classList.remove('hidden');
            } else if (mode === 'edit' && product) {
                modalTitle.textContent = 'Edit Product';
                saveButton.textContent = 'Update Product';
                saveButton.onclick = () => handleProductUpdate(product.id);

                try {
                    document.getElementById('productId').value = product.id || '';
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productBarcode').value = product.barcode || '';
                    document.getElementById('purchaseDate').value = formatDateForInput(product.purchaseDate);
                    document.getElementById('purchasePrice').value = product.purchasePrice;
                    document.getElementById('salesPrice').value = product.salesPrice;
                    document.getElementById('supplier').value = product.vendor || '';
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('quantity').value = product.quantity;
                    document.getElementById('categorySelect').value = product.category || '';
                    document.getElementById('Store').value = product.storeNumber || '';
                } catch (error) {
                    console.error('Error populating form fields:', error);
                }

                // Hide the Product ID field when editing
                document.getElementById('productIdGroup').classList.add('hidden');
            }

            // Display the modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden'); // Prevent background scrolling
        }

        // Function to close the Product Modal
        function closeProductModal() {
            const modal = document.getElementById('productModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden'); // Allow background scrolling
        }

        function formatDateForInput(dateInput) {
            if (!dateInput) return '';
            const date = new Date(dateInput);
            if (isNaN(date)) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function showPromotionModal(mode = 'add') {
            const promotionForm = document.getElementById('promotionForm');
            if (promotionForm) {
                if (mode === 'add') {
                    promotionForm.reset();
                }
            } else {
                console.error("promotionForm not found in the DOM.");
            }

            await populatePromotionProducts(); // Wait for products to be populated

            // Set modal title and button text based on mode
            const modalTitle = document.getElementById('promotionModalTitle');
            const saveButton = document.querySelector('#promotionModal .save-button');

            if (mode === 'add') {
                modalTitle.textContent = 'Add Promotion';
                saveButton.textContent = 'Save Promotion';
                saveButton.onclick = handlePromotionSubmit;
            } else if (mode === 'edit') {
                modalTitle.textContent = 'Edit Promotion';
                // Note: The saveButton's onclick handler is set in the editPromotion function
            }

            const modal = document.getElementById('promotionModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden'); // Prevent background scrolling
        }

        // Function to close the Promotion Modal
        function closePromotionModal() {
            const modal = document.getElementById('promotionModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden'); // Allow background scrolling
        }

        // Global variables to store fetched data
        let products = [];
        let promotions = [];
        let mergedProducts = [];
        let categories = []; // To store extracted categories

        // Initialize page
         document.addEventListener('DOMContentLoaded', function () {
           
            const role = localStorage.getItem('adminRole'); // Retrieve role

            // Adjust menu based on role
            adjustMenuBasedOnRole(role);

        // If role is not 'Owner' or 'Manager', redirect to 'newSale4.html'
        if (role !== 'owner' && role !== 'manager') {
            window.location.href = 'newSale4.html';
            return;
        }

         

            fetchData();
            fetchSuppliers();
            fetchPromotions();
            setupEventListeners();

         });


         function adjustMenuBasedOnRole(role) {
            const dashboardMenu = document.getElementById('dashboardMenu');
            const newSaleMenu = document.getElementById('newSaleMenu');
            const inventoryMenu = document.getElementById('inventoryMenu');
            const ordersMenu = document.getElementById('ordersMenu');
            const suppliersMenu = document.getElementById('suppliersMenu');
            const customersMenu = document.getElementById('customersMenu');
            const adminAccessMenu = document.getElementById('adminAccessMenu');
            const reportsMenu = document.getElementById('reportsMenu');
            const gainsMenu = document.getElementById('gainsMenu');

            if (role === 'owner') {
                // Do nothing, show all menus
            } else if (role === 'manager') {
                // Hide adminAccessMenu and reportsMenu
                if (adminAccessMenu) adminAccessMenu.style.display = 'none';
                if (reportsMenu) reportsMenu.style.display = 'none';
                if (gainsMenu) gainsMenu.style.display = 'none';

            } else {
                // For other roles, only show newSaleMenu and ordersMenu
                if (dashboardMenu) dashboardMenu.style.display = 'none';
                if (inventoryMenu) inventoryMenu.style.display = 'none';
                if (suppliersMenu) suppliersMenu.style.display = 'none';
                if (customersMenu) customersMenu.style.display = 'none';
                if (adminAccessMenu) adminAccessMenu.style.display = 'none';
                if (reportsMenu) reportsMenu.style.display = 'none';
                if (gainsMenu) gainsMenu.style.display = 'none';

            }
        }
       

       

        // Fetch products and promotions from APIs
        async function fetchData() {
            try {
                // Fetch products
                const productsResponse = await fetch('http://localhost:8080/api/products');
                if (!productsResponse.ok) throw new Error(`Products API error: ${productsResponse.status}`);
                products = await productsResponse.json();
                console.log('Products:', products); // Debugging Output

                // Fetch promotions
                let promotionsData = [];
                try {
                    const promotionsResponse = await fetch('http://localhost:8080/api/products-with-promotions');
                    if (!promotionsResponse.ok) throw new Error(`Promotions API error: ${promotionsResponse.status}`);
                    promotionsData = await promotionsResponse.json();
                    promotions = promotionsData;
                    console.log('Promotions:', promotions); // Debugging Output
                } catch (promoError) {
                    console.error('Error fetching promotions:', promoError);
                    showAlert('Failed to fetch promotions data. Promotions will not be applied.', 'error');
                    promotions = [];
                }

                // Merge products with promotions without filtering by promo.active
                mergedProducts = products.map(product => {
                    const promo = promotions.find(p => p.productId === product.id);

                    // Convert date strings to epoch milliseconds if necessary
                    if (promo) {
                        if (typeof promo.promotionStartDate === 'string') {
                            promo.promotionStartDate = new Date(promo.promotionStartDate).getTime();
                        }
                        if (typeof promo.promotionEndDate === 'string') {
                            promo.promotionEndDate = new Date(promo.promotionEndDate).getTime();
                        }
                    }

                    return {
                        ...product,
                        promoId: promo?.promoId || null,
                        discountPercentage: promo?.discountPercentage || null,
                        promotionDescription: promo?.promotionDescription || null,
                        promotionStartDate: promo?.promotionStartDate || null,
                        promotionEndDate: promo?.promotionEndDate || null,
                        activePromotion: isPromotionCurrentlyActive(promo)
                    };
                });

                console.log('Merged Products:', mergedProducts); // Debugging Output

                // (Optional) Store mergedProducts in localStorage for persistence
                localStorage.setItem('mergedProducts', JSON.stringify(mergedProducts));

                // Extract unique categories from mergedProducts
                extractCategories();

                // Display inventory
                updateInventoryDisplay();
                updateStatistics();
            } catch (error) {
                console.error('Error fetching data:', error);
                showAlert('Failed to fetch product data. Please try again later.', 'error');
            }
        }

        // Helper function to determine if a promotion is currently active based on dates and valid data
        function isPromotionCurrentlyActive(promo) {
            if (!promo) return false;

            const currentDate = Date.now();
            const startDate = promo.promotionStartDate;
            const endDate = promo.promotionEndDate;

            // Check if both startDate and endDate exist and are valid
            if (startDate && endDate) {
                const isWithinDateRange = currentDate >= startDate && currentDate <= endDate;
                const hasValidDiscount = promo.discountPercentage != null && promo.discountPercentage > 0;
                const hasValidDescription = promo.promotionDescription && promo.promotionDescription.trim() !== '';

                const isActive = isWithinDateRange && hasValidDiscount && hasValidDescription;
                console.log(`Promotion ID ${promo.promoId} active: ${isActive}`);
                return isActive;
            }

            // If no startDate and endDate are provided, assume promotion is active only if discountPercentage and description are present
            const hasValidDiscount = promo.discountPercentage != null && promo.discountPercentage > 0;
            const hasValidDescription = promo.promotionDescription && promo.promotionDescription.trim() !== '';
            const isActive = hasValidDiscount && hasValidDescription;

            console.log(`Promotion ID ${promo.promoId} active (no date range): ${isActive}`);
            return isActive;
        }

        // Extract unique categories from mergedProducts and populate dropdowns
        function extractCategories() {
            const categorySet = new Set();

            mergedProducts.forEach(product => {
                if (product.category && product.category.trim() !== '') {
                    categorySet.add(product.category.trim());
                }
            });

            categories = Array.from(categorySet).sort(); // Sort categories alphabetically
            console.log('Extracted Categories:', categories); // Debugging Output

            populateCategoryDropdowns();
        }

        // Populate Category Filter and Product Modal Category Select
        function populateCategoryDropdowns() {
            // Populate categorySelect in the product modal
            const categorySelect = document.getElementById('categorySelect');
            categorySelect.innerHTML = '<option value="">Select category...</option>';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = capitalizeFirstLetter(category);
                categorySelect.appendChild(option);
            });

            // Add "Add New Category" option
            const newOption = document.createElement('option');
            newOption.value = 'newCategory';
            newOption.textContent = 'Add New Category';
            categorySelect.appendChild(newOption);

            // Populate categoryFilter in the filters section
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = capitalizeFirstLetter(category);
                categoryFilter.appendChild(option);
            });
        }

        // Fetch suppliers and populate supplier dropdown
        async function fetchSuppliers() {
            try {
                const response = await fetch('http://localhost:8080/api/suppliers'); // Adjust the URL as needed
                if (!response.ok) throw new Error(`Suppliers API error: ${response.status}`);
                const suppliers = await response.json();

                const supplierSelect = document.getElementById('supplier');
                supplierSelect.innerHTML = '<option value="">Select supplier...</option>';
                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.supplierName; // Correct field from the API response
                    option.textContent = `${supplier.supplierName} - ${supplier.contactPerson || 'N/A'}`;
                    supplierSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching suppliers:', error);
                // Optionally, keep the supplier field as a text input if fetching fails
            }
        }

        // Update inventory display based on mergedProducts
        function updateInventoryDisplay() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filteredInventory = mergedProducts.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                    (item.barcode && item.barcode.toLowerCase().includes(searchTerm));
                const matchesCategory = !categoryFilter || item.category.toLowerCase() === categoryFilter.toLowerCase();
                const matchesStock = !stockFilter ||
                    (stockFilter === 'instock' && item.quantity > 15) ||
                    (stockFilter === 'lowstock' && item.quantity >= 5 && item.quantity <= 15) ||
                    (stockFilter === 'outofstock' && item.quantity < 5);

                return matchesSearch && matchesCategory && matchesStock;
            });

            // Sort inventory
            filteredInventory.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'stock':
                        return b.quantity - a.quantity;
                    case 'price':
                        // Apply discount if promotion is active
                        const priceA = parseFloat(getEffectivePrice(a));
                        const priceB = parseFloat(getEffectivePrice(b));
                        return priceB - priceA;
                    case 'storeNumber':
                        return (a.storeNumber || 0) - (b.storeNumber || 0); // Handle undefined values
                    default:
                        return 0;
                }
            });

            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            filteredInventory.forEach(item => {
                const row = document.createElement('tr');
                row.classList.add(item.activePromotion ? 'bg-purple-100' : 'bg-white');

                row.innerHTML = `
    <td class="py-4 px-6">${item.name}</td>
    <td class="py-4 px-6">${item.barcode || 'N/A'}</td>
    <td class="py-4 px-6">${capitalizeFirstLetter(item.category)}</td>
    <td class="py-4 px-6">${item.quantity}</td>
    <td class="py-4 px-6">${item.storeNumber || 'N/A'}</td>
    <td class="py-4 px-6">
        ${item.activePromotion ? `
            <span class="line-through text-gray-500">${item.salesPrice.toFixed(2)} دج</span>
            <span class="ml-2 text-green-500">${getEffectivePrice(item)}</span>
        ` : `
            ${item.salesPrice.toFixed(2)} دج
        `}
    </td>
    <td class="py-4 px-6">
        ${item.activePromotion ? `
            <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-purple-200 text-purple-800">
                ${item.discountPercentage}% Off - ${item.promotionDescription}
            </span>
        ` : `
            N/A
        `}
    </td>
    <td class="py-4 px-6">
        ${getStockStatusBadge(item.quantity)}
    </td>
    <td class="py-4 px-6 flex space-x-2">
        <button onclick="editProduct(${item.id})" title="Edit" class="text-blue-500 hover:text-blue-700">
            <img src="icons/edit.svg" alt="Edit Icon" class="w-5 h-5" />
        </button>
        <button onclick="deleteProduct(${item.id})" title="Delete" class="text-red-500 hover:text-red-700">
            <img src="icons/trash-2.svg" alt="Delete Icon" class="w-5 h-5" />
        </button>
    </td>
`;


                tbody.appendChild(row);
            });
        }

        function getEffectivePrice(product) {
    if (isPromotionActive(product)) {
        return (product.salesPrice * (1 - (product.discountPercentage || 0) / 100)).toFixed(2) + ' دج';
    }
    return product.salesPrice.toFixed(2) + ' دج';
}


        // Helper function to check if promotion is active
        function isPromotionActive(product) {
            return product.activePromotion;
        }

        // Helper function to get stock status badge
        function getStockStatusBadge(stock) {
            if (stock > 15) {
                return '<span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-green-200 text-green-800">In Stock</span>';
            } else if (stock >= 5 && stock <= 15) {
                return '<span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-yellow-200 text-yellow-800">Low Stock</span>';
            } else if (stock > 0 && stock < 5) {
                return '<span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-red-200 text-red-800">Critical</span>';
            } else {
                return '<span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-red-200 text-red-800">Out of Stock</span>';
            }
        }

        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Update statistics based on mergedProducts
        function updateStatistics() {
            const totalProducts = mergedProducts.length;
            const inStock = mergedProducts.filter(item => item.quantity > 15).length;
            const lowStock = mergedProducts.filter(item => item.quantity >= 5 && item.quantity <= 15).length;
            const outOfStock = mergedProducts.filter(item => item.quantity < 5).length;

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('inStockCount').textContent = inStock;
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('outOfStockCount').textContent = outOfStock;
        }

        // Setup event listeners for buttons and filters
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', updateInventoryDisplay);
            document.getElementById('categoryFilter').addEventListener('change', updateInventoryDisplay);
            document.getElementById('stockFilter').addEventListener('change', updateInventoryDisplay);
            document.getElementById('sortBy').addEventListener('change', updateInventoryDisplay);

            // Close modals on 'Esc' key press
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeProductModal();
                    closePromotionModal();
                }
            });

            // Handle 'Enter' key in modals to submit forms
            const modals = ['productModal', 'promotionModal'];
modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (modal) {  // Check if the modal exists
        modal.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission on Enter
                const saveButton = modal.querySelector('.save-button');
                if (saveButton) {
                    saveButton.click();
                }
            }
        });
    } else {
        console.warn(`Modal with ID "${modalId}" not found.`);
    }
});

        }

        // Handle Add Product Form Submit
        async function handleProductSubmit() {
            const productName = getInputValue('productName');
            const purchaseDateStr = getInputValue('purchaseDate');
            const purchasePriceStr = getInputValue('purchasePrice');
            const priceStr = getInputValue('salesPrice'); // Use 'priceStr' instead of 'salesPriceStr'
            const supplier = getInputValue('supplier');
            const quantityStr = getInputValue('quantity');
            const category = getCategoryValue();
            const storeInputStr = getInputValue('Store');

            // Check for missing required fields
            const requiredFields = {
                'Product Name': productName,
                'Purchase Date': purchaseDateStr,
                'Purchase Price': purchasePriceStr,
                'Selling Price': priceStr,
                'Supplier': supplier,
                'Quantity': quantityStr,
                'Category': category,
                'Store': storeInputStr
            };

            const missingFields = Object.entries(requiredFields)
                .filter(([_, value]) => value.trim() === '')
                .map(([key]) => key);

            if (missingFields.length > 0) {
                showAlert(`Please fill in the following required fields: ${missingFields.join(', ')}`, 'error');
                return;
            }

            // Parse numeric fields
            const purchasePrice = parseFloat(purchasePriceStr);
            const price = parseFloat(priceStr);
            const quantity = parseInt(quantityStr, 10);
            const storeNumber = parseInt(storeInputStr, 10);

            // Validate numeric fields
            if (isNaN(purchasePrice) || isNaN(price) || isNaN(quantity) || isNaN(storeNumber)) {
                showAlert('Please enter valid numbers for Purchase Price, Selling Price, Quantity, and Store Number.', 'error');
                return;
            }

            // Parse purchase date to epoch milliseconds if backend expects it
            const purchaseDate = new Date(purchaseDateStr).getTime();

            // Proceed with API call
            const productDTO = {
                name: productName,
                barcode: getInputValue('productBarcode') || null,
                description: getInputValue('description') || '',
                price: price,                           // Use 'price'
                purchasePrice: purchasePrice,
                purchaseDate: purchaseDate,             // Include 'purchaseDate'
                quantity: quantity,
                category,
                vendor: supplier,
                storeNumber: storeNumber,
                isActive: true                          // Use 'isActive' instead of 'active'
            };

            try {
                const response = await fetch('http://localhost:8080/api/addproduct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productDTO),
                });

                if (response.status === 201) {
                    showAlert('The product has been added successfully!', 'success');
                    closeProductModal();
                    await fetchData();
                } else {
                    const errorData = await response.json();
                    showAlert(`Failed to add product: ${errorData.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error adding product:', error);
                showAlert('An error occurred while adding the product. Please try again.', 'error');
            }
        }

        // Handle Product Update
        async function handleProductUpdate(id) {
            const productName = getInputValue('productName');
            const productBarcode = getInputValue('productBarcode');
            const purchaseDateStr = getInputValue('purchaseDate'); // "YYYY-MM-DD"
            const purchasePriceStr = getInputValue('purchasePrice');
            const priceStr = getInputValue('salesPrice'); // Use 'priceStr' instead of 'salesPriceStr'
            const supplier = getInputValue('supplier');
            const description = getInputValue('description');
            const quantityStr = getInputValue('quantity');
            const category = getCategoryValue(); // Use getCategoryValue()
            const storeInputStr = getInputValue('Store'); // Use 'Store' with capital 'S'

            // Validate required fields
            const requiredFields = {
                'Product Name': productName,
                'Purchase Date': purchaseDateStr,
                'Purchase Price': purchasePriceStr,
                'Selling Price': priceStr,
                'Supplier': supplier,
                'Quantity': quantityStr,
                'Category': category,
                'Store': storeInputStr
            };

            const missingFields = Object.entries(requiredFields)
                .filter(([key, value]) => value.trim() === '')
                .map(([key, _]) => key);

            if (missingFields.length > 0) {
                showAlert(`Please fill in the following required fields: ${missingFields.join(', ')}`, 'error');
                return;
            }

            // Parse numeric fields
            const purchasePrice = parseFloat(purchasePriceStr);
            const price = parseFloat(priceStr); // Use 'price' instead of 'salesPrice'
            const quantity = parseInt(quantityStr, 10);
            const storeNumber = parseInt(storeInputStr, 10);

            // Validate numeric fields
            if (isNaN(purchasePrice) || isNaN(price) || isNaN(quantity) || isNaN(storeNumber)) {
                showAlert('Please enter valid numbers for Purchase Price, Selling Price, Quantity, and Store Number.', 'error');
                return;
            }

            // Parse purchase date to epoch milliseconds if backend expects it
            const purchaseDate = new Date(purchaseDateStr).getTime();

            // Create updated ProductDTO object with correct property names
            const updatedProductDTO = {
                id: parseInt(id, 10),
                name: productName,
                barcode: productBarcode || null,
                description: description || '',
                price: price,                           // Use 'price'
                purchasePrice: purchasePrice,
                purchaseDate: purchaseDate,             // Include 'purchaseDate'
                quantity: quantity,
                category: category || '',
                vendor: supplier || null,
                storeNumber: storeNumber,
                isActive: true                          // Use 'isActive' instead of 'active'
            };

            console.log('Updated Product Data:', updatedProductDTO);

            try {
                const response = await fetch(`http://localhost:8080/api/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedProductDTO),
                });

                if (response.ok) {
                    showAlert('Product updated successfully!', 'success');
                    closeProductModal();
                    document.getElementById('productForm').reset();
                    // Reset Save button to handle additions
                    const saveButton = document.querySelector('#productModal .save-button');
                    saveButton.onclick = handleProductSubmit;
                    // Refresh data
                    await fetchData();
                } else {
                    const errorData = await response.json();
                    showAlert(`Failed to update product: ${errorData.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error updating product:', error);
                showAlert('An error occurred while updating the product. Please try again.', 'error');
            }
        }

        function editProduct(id) {
            console.log('editProduct called with id:', id);
            const product = mergedProducts.find(item => item.id === id);
            if (product) {
                console.log('Product found:', product);
                showProductModal('edit', product);
            } else {
                showAlert('Error', 'Product not found.', 'error');
            }
        }

        // Delete Product Function
        async function deleteProduct(id) {
            const confirmed = window.confirm("Are you sure you want to delete this product? This action cannot be undone.");
            if (confirmed) {
                try {
                    const response = await fetch(`http://localhost:8080/api/products/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        showAlert("Product deleted successfully.", 'success');
                        await fetchData();
                    } else {
                        showAlert("Failed to delete product.", 'error');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showAlert("Error occurred while deleting the product.", 'error');
                }
            }
        }

        // Populate products in the promotion modal
        async function populatePromotionProducts() {
            try {
                const response = await fetch('http://localhost:8080/api/products');
                if (!response.ok) throw new Error(`Error fetching products: ${response.status}`);
                const products = await response.json();

                const productSelect = document.getElementById('promotionProducts');
                productSelect.innerHTML = ''; // Clear existing options

                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (ID: ${product.id})`;
                    productSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating products:', error);
                showAlert('Failed to load products. Please try again later.', 'error');
            }
        }

        // Handle Promotion Form Submit
        async function handlePromotionSubmit() {
    const description = getInputValue('promotionDescription');
    const startDate = formatDateForBackend(getInputValue('promotionStartDate'));
    const endDate = formatDateForBackend(getInputValue('promotionEndDate'));
    const discount = getInputValue('promotionDiscount');
    const productIds = Array.from(document.getElementById('promotionProducts').selectedOptions)
        .map(opt => parseInt(opt.value));

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showAlert('Start date must be before the end date.', 'error');
        return;
    }

    const promotionDTO = {
        description,
        startDate,
        endDate,
        discountPercentage: parseFloat(discount),
        productIds,
        active: true
    };

    try {
        const response = await fetch('http://localhost:8080/api/create-promo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(promotionDTO),
        });

        if (response.ok) {
            showAlert('The promotion has been created successfully!', 'success');
            closePromotionModal();
            await fetchPromotions(); // Refresh promotions data
        } else {
            const errorData = await response.json();
            showAlert(errorData.error || 'A promotion with similar details already exists.', 'error');
        }
    } catch (error) {
        console.error('Error creating promotion:', error);
        showAlert('An error occurred. Please try again.', 'error');
    }
}


        // Helper function to get input value by ID
        function getInputValue(id) {
            const input = document.getElementById(id);
            if (input) {
                return input.value.trim();
            }
            return '';
        }

        // Fetch all promotions
        async function fetchPromotions() {
            try {
                const response = await fetch('http://localhost:8080/api/promotions');
                if (!response.ok) throw new Error('Failed to fetch promotions');
                const allPromotions = await response.json();

                promotions = allPromotions; // Assign to global variable

                // Filter only active promotions
                const activePromotions = allPromotions.filter(promo => promo.active);
                populatePromotionsTable(activePromotions);
            } catch (error) {
                console.error('Error fetching promotions:', error);
                showAlert('Failed to load promotions.', 'error');
            }
        }

        // Populate promotions table
        function populatePromotionsTable(promotions) {
            const tbody = document.getElementById('promotionsTableBody');
            tbody.innerHTML = ''; // Clear existing rows

            promotions.forEach(promo => {
                const hasEnded = new Date(promo.endDate).getTime() < Date.now();

                const row = document.createElement('tr');
                row.classList.add(hasEnded ? 'bg-red-100' : 'bg-white');

                row.innerHTML = `
                    <td class="py-4 px-6">${promo.promoId}</td>
                    <td class="py-4 px-6">${promo.description}</td>
                    <td class="py-4 px-6">${formatArrayToDate(promo.startDate)}</td>
                    <td class="py-4 px-6 ${hasEnded ? 'text-red-500' : ''}">${formatArrayToDate(promo.endDate)}</td>
                    <td class="py-4 px-6">${promo.discountPercentage}%</td>
                    <td class="py-4 px-6">${promo.active ? 'Active' : 'Inactive'}</td>
                    <td class="py-4 px-6 flex space-x-2">
                        <button onclick="editPromotion(${promo.promoId})" title="Edit" class="text-blue-500 hover:text-blue-700">
                            <img src="icons/edit.svg" alt="Edit Icon" class="w-5 h-5" />
                        </button>
                        <button onclick="deletePromotion(${promo.promoId})" title="Delete" class="text-red-500 hover:text-red-700">
                            <img src="icons/trash-2.svg" alt="Delete Icon" class="w-5 h-5" />
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Format date for display (assuming date is in ISO format)
        function formatDateToDisplay(dateInput) {
            let date;
            if (Array.isArray(dateInput)) {
                const [year, month, day, hour = 0, minute = 0, second = 0] = dateInput;
                date = new Date(year, month - 1, day, hour, minute, second);
            } else if (typeof dateInput === 'string' || typeof dateInput === 'number') {
                date = new Date(dateInput);
            } else {
                return 'Invalid Date';
            }

            const formattedYear = date.getFullYear();
            const formattedMonth = String(date.getMonth() + 1).padStart(2, '0');
            const formattedDay = String(date.getDate()).padStart(2, '0');
            return `${formattedYear}-${formattedMonth}-${formattedDay}`;
        }

        // Call the fetchPromotions function on page load
        document.addEventListener('DOMContentLoaded', fetchPromotions);

        // Edit Promotion Function
        async function editPromotion(promoId) {
            try {
                // Fetch promotion details including productIds
                const response = await fetch(`http://localhost:8080/api/promotions/${promoId}`);
                if (!response.ok) throw new Error('Failed to fetch promotion details');
                const promo = await response.json();

                await showPromotionModal('edit');

                // Populate form fields
                document.getElementById('promotionDescription').value = promo.description || '';
                document.getElementById('promotionStartDate').value = formatArrayToDate(promo.startDate);
                document.getElementById('promotionEndDate').value = formatArrayToDate(promo.endDate);
                document.getElementById('promotionDiscount').value = promo.discountPercentage || '';

                // Select associated products
                const productSelect = document.getElementById('promotionProducts');
                Array.from(productSelect.options).forEach(option => {
                    option.selected = promo.productIds.includes(parseInt(option.value, 10));
                });

                const saveButton = document.querySelector('#promotionModal .save-button');
                saveButton.textContent = 'Update Promotion';
                saveButton.onclick = () => updatePromotion(promoId);
            } catch (error) {
                console.error('Error editing promotion:', error);
                showAlert('Failed to load promotion details.', 'error');
            }
        }

        // Helper function to format date arrays to 'YYYY-MM-DD'
        function formatArrayToDate(dateArray) {
            if (!Array.isArray(dateArray) || dateArray.length < 3) return 'Invalid Date';
            const [year, month, day] = dateArray;
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('customAlert');

            // Set message and type (success or error)
            alertBox.textContent = message;
            alertBox.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 max-w-sm p-4 rounded-lg shadow-lg z-50 text-white text-center text-lg transition-opacity duration-300';
            if (type === 'success') {
                alertBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                alertBox.classList.add('bg-red-500');
            }
            alertBox.classList.remove('opacity-0', 'invisible');
            alertBox.classList.add('opacity-100', 'visible');

            // Automatically hide the alert after 3 seconds
            setTimeout(() => {
                alertBox.classList.remove('opacity-100', 'visible');
                alertBox.classList.add('opacity-0', 'invisible');
            }, 3000);
        }

        // Update Promotion Function
        // Update Promotion Function (for updating an existing promotion)
async function updatePromotion(promoId) {
    const description = getInputValue('promotionDescription');
    const startDate = formatDateForBackend(getInputValue('promotionStartDate'));
    const endDate = formatDateForBackend(getInputValue('promotionEndDate'));
    const discount = parseFloat(getInputValue('promotionDiscount'));
    const productIds = Array.from(document.getElementById('promotionProducts').selectedOptions)
        .map(option => parseInt(option.value, 10));

    const promotionDTO = {
        promoId,
        description,
        startDate,
        endDate,
        discountPercentage: discount,
        productIds,
        active: true // Adjust based on your logic
    };

    console.log('Sending Update:', promotionDTO); // Debugging output

    try {
        const response = await fetch(`http://localhost:8080/api/promo/${promoId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(promotionDTO)
        });

        if (response.ok) {
            showAlert('Promotion updated successfully!', 'success');
            closePromotionModal();
            await fetchPromotions(); // Refresh promotions data
        } else {
            const errorData = await response.json();
            console.error('Update failed:', errorData);
            showAlert(`Failed to update promotion: ${errorData.message || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error updating promotion:', error);
        showAlert('An unexpected error occurred.', 'error');
    }
}


        // Delete Promotion Function
        async function deletePromotion(promoId) {
            const confirmed = window.confirm("Are you sure you want to delete this promotion? This action cannot be undone.");
            if (confirmed) {
                try {
                    const response = await fetch(`http://localhost:8080/api/delete/${promoId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showAlert('The promotion has been deleted.', 'success');
                        await fetchPromotions(); // Refresh promotions list
                    } else {
                        showAlert('Failed to delete promotion.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting promotion:', error);
                    showAlert('An error occurred. Please try again.', 'error');
                }
            }
        }

        // Helper function to format date for backend
        function formatDateForBackend(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}T00:00:00`;
        }

        // Helper function to get input value by ID
        function getCategoryValue() {
            const categorySelect = document.getElementById('categorySelect');
            const categoryInput = document.getElementById('categoryInput');

            // If "Add New Category" is selected, use the value from the input field
            if (categorySelect.value === 'newCategory') {
                return categoryInput.value.trim();
            }
            // Otherwise, use the selected category from the dropdown
            return categorySelect.value.trim();
        }

        // Toggle Category Input Visibility
        function toggleCategoryInput() {
            const categorySelect = document.getElementById('categorySelect');
            const categoryInput = document.getElementById('categoryInput');
            if (categorySelect.value === 'newCategory') {
                categoryInput.classList.remove('hidden');
                categoryInput.required = true; // Make it required if adding a new category
            } else {
                categoryInput.classList.add('hidden');
                categoryInput.required = false;
                categoryInput.value = ''; // Clear input when hidden
            }
        }

    </script>
</body>

</html>
